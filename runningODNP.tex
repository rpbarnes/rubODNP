\documentclass{article}
\usepackage{fancyhdr}
\usepackage{color}
\usepackage{cite}
\pagestyle{fancy}
\lhead{New ODNP Commands}
\rhead{\thepage}
\cfoot{Ryan Barnes}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}
\newcommand{\fc}[1]{{\color{blue}\textit{'{#1}'}}}

\title{Running ODNP}
\author{Ryan Barnes - Songi Han's Lab}

\begin{document}
\maketitle

\section{Outline of Experimental Setup}
This document attempts to explain how to run the ODNP experiment on the setup at Ruhr Universitat Bochum. This section is more of a theoretical explination of how everything works and how each item in orchestrated into the bigger picture. See section~\ref{sec:runningODNP} for the practical outline on setting up and running the experiment.

The ODNP experiment is primarily an NMR experiment in that we measure the NMR signal, but enahancement and $T_1$ of the proton of water as a function of microwave power so all that is done on the EPR side is to change the microwave power. Therefore this experiment is primarily run by TOPSPIN however the experiment is also dependent on Xepr to set the microwave power which is managed by TOPSPIN through an instrument server.

\subsection{Enhancement Measurement}
In the ODNP experiment it is necessary to measure the NMR signal enhancement as a function of microwave power. We measure the NMR signal enhancement via the integral of the Fourier Transform of the FID. We typically use a 4 step CYCLOPS phase cycle for each enhancement measurement at a given microwave power. Note that the CYCLOPS routine is just to eliminate an offsets due to the IQ mixer and such.

We measure the NMR signal enhancement for a given power setting, see section~\ref{sec:micPower}. We also record the microwave power throughout the enhancement measurement for a given power setting, see section~\ref{sec:measPower}. To calculate the overall signal enhancement we plot the integral of the NMR signal against the corresponding microwave power, we extrapolate this to infinite power and whalahh.

In the experiment file the enhancement measurements start at experiment 5 and continue to 5 + the number of enhancement steps (defined in the exp setup)

\subsection{$T_1$ Measurement}
In the ODNP measurement we measure the nuclear $T_1$ as a function of the microwave power as well. This is an attempt to correct for the temperature change during the experiment ~\cite{Franck2013}.


\subsection{Setting Microwave Power}
\label{sec:micPower}
This is taken care of automatically by the ODNP code \fc{'dnpexp'} as well as \fc{'mwpower'} which just sets the microwave power and amplifier state. Both commands \fc{'dnpexp'} and \fc{'mwpower'} are issued in the TOPSPIN command line as this is the main user interface.

TOPSPIN issues the microwave power setting commands to the Xepr software via the instrument servers, see section~\ref{sec:instServer}. Xepr ultimately is the program that controls the microwave power adjustment. This is done via adjusting the high power attenuation setting in pulse mode.



\subsection{Measuring Microwave Power}
\label{sec:measPower}

We measure the microwave power with the gigatronics microwave power meter. It's necessary to sample the microwave power after the high power amplifier so right now the sampling occurs between the microwave bridge output and the cavity. This isn't ideal as it reduces the cw-EPR signal to noise by about 85\% which isn't good.



\subsection{Instrument Servers}
\label{sec:instServer}
For the setup in Bochum two instrument servers are required each running on it's own computer. That is one runs on the TOPSPIN computer and one runs on the Xepr computer and they're named accordingly 'instrumentServerTopspin.py' and 'instrumentServerElexsys.py' and they're both stored in the rubODNP directory on each computer. If you note both computers hold an identical copy of the directory, as the directory is managed by git. As you may be able to tell both servers are python programs, as python is awesome!

The server running on the TOPSPIN computer is the parent or the 'main hub' this server listens for commands from TOPSPIN and parses commands either to the Xepr server (for setting the microwave power) or to the power meter (for measuring microwave power).

TOPSPIN communicates to the server on the TOPSPIN computer via a TCP/IP communication, in reality the TOPSPIN program can talk just as easilly to the server on the Xepr computer I just thought it better to have all communication go through one server. In this format TOPSPIN gives commands to the server but does not recieve commands from the server

Xepr only receives commands from the server on the Xepr computer and does not issue commands to either server. Really because Xepr sucks and there is no reason for it. Communication between Xepr and the server occurs via the XeprAPI which is Bruker's method of allowing python to manage the Xepr platform.


\subsection{File Locations}
\label{sec:fileLocs}
The files pertinent to the ODNP experiment are contained in different locations on both computers because well my organization blows... Any way the instrument servers are stored in the rubODNP folder. On the topspin box this is in \fc{C:/Projects/rubODNP} on the xepr box this is in the \fc{/home/xuser/Projects/rubODNP}.

I store the ODNP pulse program and variable defs for xepr in \fc{/home/xuser/xeprFiles/PulseSPEL/sharedPulseSPEL/standard/dnpElexsys/}.

I store the code to run the ODNP experiment, make a new experiment file, run $T_1$ experiments, and set the microwave power in \fc{C:/Bruker/TopSpin3.2/exp/stan/nmr/au/src}. Note all of the files are written in c. If you change or edit any of the files all you need to do to compile the files is to write the filename in the topspin command window and it will compile the file and run it. I go through what each of these files are used for in section~\ref{sec:odnpCommands}



\subsection{ODNP Specific Topspin Commands}
\label{sec:odnpCommands}

There are a couple of commands that can be called from the Topspin command line that are pertinent to setting up and running the ODNP experiment. I go through these commands here. All of the scripts are housed in \fc{C:/Bruker/TopSpin3.2/exp/stan/nmr/au/src}, for example the code for the command mwpower is stored in a script called mwpower.

\subsubsection{mwpower}
The command \fc{mwpower} sets the attenuation of the high power attenuator in the bridge as well as the state of the microwave bridge. You can use this to manually adjust the power of the microwave output as well as turn the microwave output on or off. 

The command operates by communicating with both the server on the Topspin computer and the xepr computer. The commands are initially parsed in the script executed by topspin and sent to the server running on the topspin computer. The server on the topspin computer interprets the command as something for the xepr software and passes the command along to xepr. In all cases the server on the topspin computer is the parent and the server on the xepr computer is the child.


\subsubsection{newexp}
The command \fc{newexp} copies experiment numbers 1-5 in the currently selected experiment directory and deletes any data stored in the experiment. Experiments 1-5 are templates for the ODNP experiment. This is a handy tool to just make sure everything that you need for a successful ODNP experiment is copied successfully from a previous ODNP experiment.

\subsubsection{dnpexp}
The command \fc{dnpexp} is what actually runs the ODNP experiment. This will run the NMR enhancement as a function of microwave power automatically. This will also run the NMR $T_1$ as a function of microwave power. This command will output data in the form that can be worked up by Ryan's workup software.

The command will grab all of the optimization parameters given in experiment 1. This includes the RF (SFO1), pulse power (PLW1), and pulse length (P1) and copy these parameters to the template files for the enhancement series (experiment 5) and the $T_1$ series (experiment 4).

The experiment proceedes as follows:
\begin{enumerate}
	\item{Check the receiver noise}
	\item{Measure the thermal NMR signal, exp 5}
	\item{Let the amplifier warm up}
	\item{Measure the enhancement series, exp 6 - number of attenuation steps + 6}
	\item{Turn the microwave pulsing off and let the sample cool down}
	\item{Measure the zero power $T_1$, exp 304}
	\item{Let the amplifier warm up}
	\item{Measure the $T_1$ of power series, exp (number of attenuation steps + 6) - exp (number of attenuation steps + 6 + t1type)}
\end{enumerate}

There are several parameters that one could edit to change the odnp experiment.



\section{Setting up and Running The ODNP Experiment}
\label{sec:runningODNP}



\section{Observed Bugs with Xepr}
Yes this software blows, however it's what we have to deal with so we must get through it.

On a side note being Xepr is buggy it is very possible / simple to utilize the auxillary output of the microwave bridge and circumvent the use of Xepr for the ODNP experiment. In this context you would just configure the aux microwave output to go through a digital attenuator (seperately purchased) then go to the Bruker solid state amplifier. Here you could use a raspberry pi to set the attenuation of the attenuator and to trigger the solid state amplifier. \fc{This setup would free the ODNP experiment from Xepr, which if Xepr continues to be as buggy as it is now I think this might be a necessary thing to do! Also if you're reading this and thinking WTF? just send Ryan Barnes a mail :).}

Here I just list a collection of observed bugs that I've noticed and how I've dealt with them in the past. When you observe something that prohibits you from running an experiment there is a chance that I've observed the same bug and have listed a way to deal with it 


\begin{enumerate}
    \item {\bf Tuning window is unresponsive and shows a flat line:} \fc{First make sure the bridge is in cw mode!! If it is in pulsed mode the tuning window will do this.} I find that when I close and reopen the Xepr software the tuning window no longer responds to commands and shows a flat line, uncharacteristic of the microwave transmission line. \fc{To fix this, I close the software; I turn off the spectrometer and wait a couple seconds then turn the spectrometer back on; I then reopen the software. Now I can see the tuning dip.}

\item {\bf The green button on the console does not stay in:} It seems if you leave the power supply on and the console off for any extended period of time the breaker throws and power is not delivered to the console. \fc{To fix this go to the back of the power supply and flip the switch that is pointing down. This will turn the power to the console back on, once this occurs you can press the green button}

\item {\bf XeprAPI does not initialize in the server:} The server fails to open because the XeprAPI does not find an xepr instance. \fc{To fix this you must go into xepr and enable the XeprAPI. Go Processing -> XeprAPI -> click Enable. The server should now work.}

\end{enumerate}

\bibliography{references}{}
\bibliographystyle{plain}
\end{document}


